---
# Main tasks for transition_node role
# This role contains the actual transition logic for node instances

- name: "Transition Node - Initialize transition execution"
  set_fact:
    transition_timestamp: "{{ ansible_date_time.iso8601 }}"
    transition_success: false
    transition_actions_executed: []

- name: "Transition Node - Validate required variables"
  assert:
    that:
      - target_state is defined and target_state != ""
      - current_state is defined and current_state != ""
    fail_msg: "Missing required variables for node transition"
    success_msg: "All required variables are present for node transition"

- name: "Transition Node - Display transition parameters"
  debug:
    msg:
      - "Component: {{ component_instance | default('node') }}"
      - "Current State: {{ current_state }}"
      - "Target State: {{ target_state }}"
      - "Transition Timestamp: {{ transition_timestamp }}"

# Execute state-specific transition actions
- name: "Transition Node - Execute start actions"
  include_tasks: start_node.yml
  when: 
    - target_state is defined
    - target_state in ['STARTING', 'RUNNING']
    - not ansible_check_mode

- name: "Transition Node - Execute stop actions"
  include_tasks: stop_node.yml
  when: 
    - target_state is defined
    - target_state in ['STOPPING', 'STOPPED', 'TERMINATING', 'TERMINATED']
    - not ansible_check_mode

- name: "Transition Node - Set transition success"
  set_fact:
    transition_success: true
    transition_actions_executed: "{{ transition_actions_executed | default([]) + ['transition_completed'] }}"

- name: "Transition Node - Display transition result"
  debug:
    msg:
      - "Component: {{ component_instance | default('node') }}"
      - "Target State: {{ target_state }}"
      - "Transition Success: {{ transition_success }}"
      - "Actions Executed: {{ transition_actions_executed | join(', ') }}"
      - "Transition Timestamp: {{ transition_timestamp }}"

- name: "Transition Node - Fail if transition failed"
  fail:
    msg: "Node transition failed"
  when: not transition_success
